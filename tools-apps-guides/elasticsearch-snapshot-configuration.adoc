---
permalink: tools-apps-guides/elasticsearch-snapshot-configuration.html 
sidebar: sidebar 
keywords: Elastic, Elasticsearch, snapshot, repository, StorageGRID, object storage 
summary: 建立 Elasticsearch 快照儲存庫以使用StorageGRID物件儲存的說明。 
---
= Elasticsearch 快照儲存庫配置
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
_ 作者： Angela Cheng _

Elasticsearch 支援使用與 AWS S3 相容的物件儲存作為快照儲存庫。本文提供瞭如何使用StorageGRID作為後端物件儲存建立 Elasticsearch S3 快照儲存庫的逐步說明。



== 需求

* StorageGRID 11.8 或更高版本
* Elasticsearch 8.x 或更高版本




== 假設

讀者熟悉StorageGRID和 Elasticsearch 術語和操作。



== 指示

*步驟*

. 建立一個StorageGRID桶以用於 Elasticsearch 快照儲存庫。必須啟用儲存桶版本控制。每個儲存庫使用一個儲存桶。不要在多個儲存庫或 Elasticsearch 叢集之間共用一個儲存桶。
. 將StorageGRID租用戶存取金鑰和金鑰新增至 Elasticsearch 金鑰庫。登入 Elasticsearch 主節點，導航至 `<elasticsearch>/bin/`目錄，並使用 `elasticsearch-keystore`新增存取密鑰和密鑰。
+
範例命令：

+
[NOTE]
====
 In older Elasticsearch versions, the key names are `access.key` and `secret.key` instead of using underscores.
====
+
[listing]
----
/usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.sgdemo.access_key
Enter value for s3.client.sgdemo.access_key: <paste the access key here, it will not be displayed>

/usr/share/elasticsearch/bin/elasticsearch-keystore add s3.client.sgdemo.secret_key
Enter value for s3.client.sgdemo.secret_key: <paste the secret key here, it will not be displayed>
----
+
若要顯示金鑰，請使用“elasticsearch-keystore show <key-name>”指令。

. 對於多節點 Elasticsearch 集群，在每個節點中重複步驟 2 或查閱 Elasticsearch 文件。
. 從 Kibana Web GUI 導航到 Dev Tools Console 頁面並使用 `POST _nodes/reload_secure_settings`API 將變更套用到每個節點。
+
image:es-snapshot/es-reload-api.png["reload_secure_settings 範例截圖"]

. 使用 `PUT _snapshot`用於建立新快照儲存庫的 API。
+
在此範例中，儲存庫名稱是 `sg_snapshot_repository`，緩衝區大小與 S3 分段上傳的部分大小相對應。

+
預設協定是 HTTPS。若要將 HTTP 與StorageGRID S3 端點一起使用，請新增 `"protocol": "http"`到設定。

+
使用步驟1中建立的bucket名稱和步驟2中配置的客戶端名稱。

+
[listing]
----
PUT _snapshot/sg_snapshot_repository
{
  "type": "s3",
  "settings": {
    "bucket": "elk-snapshot",
    "client": "sgdemo",
    "path_style_access": "true",
    "endpoint": "sgdemo.netapp.com",
    "buffer_size": "512mb"
  }
}
----
+
image:es-snapshot/es-create-repository-api.png["Elasticsearch API 範例螢幕截圖"]

. 從 Kibana Web GUI 導覽至 Stack Management > Snapshot and Restore 頁面，選擇 Repositories 標籤。
+
按一下儲存庫名稱以查看詳細資訊或修改某些設置，例如每秒最大快照位元組數（預設為每個 Elasticsearch 節點 40 MB/s）。

+
對於此頁面上不可見的設置，請使用 `PUT _snapshot`開發者工具控制台中的 API 進行變更。

+
image:es-snapshot/es-snapshot-repository.png["快照儲存庫範例截圖"]

. 設定儲存桶生命週期策略來管理快照儲存桶中的非目前版本物件。例如，90 天後刪除非目前版本。
. Elastic 要求客戶端在使用非 AWS S3 儲存體來儲存快照之前對其進行驗證。
+
按照 Elastic 說明驗證設定：

+
https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-snapshot-repository-analyze[]

. 驗證後，請按照 Elasticsearch 指南建立儲存夜間快照的策略。




== 其他資源

* https://www.elastic.co/docs/api/doc/elasticsearch/group/endpoint-snapshot["Elasticsearch s3 儲存庫"]
* https://docs.netapp.com/us-en/storagegrid/ilm/how-objects-are-deleted.html#delete-s3-versioned-objects["如何刪除 S3 版本控制對象"]

